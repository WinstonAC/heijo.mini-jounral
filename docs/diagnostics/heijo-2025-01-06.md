# Heijō Mini-Journal Diagnostics Report
**Date:** January 6, 2025  
**Issues:** Microphone functionality & Splash→Login flow  
**Status:** Diagnostics Complete - No Functional Changes Made

## Executive Summary

This diagnostics-only pass investigated two critical issues in the Heijō mini-journal application:

1. **Microphone not working** - Users see "Microphone not available. Check permissions." tooltip
2. **Splash→Login double exposure** - "Heijō" appears twice/stacked during transition, sometimes gets stuck

Both issues have been instrumented with comprehensive logging and diagnostic probes. Root cause analysis reveals specific technical problems with clear remediation paths.

## Issue A: Microphone Functionality

### Problem Description
- **Symptom:** Mic button shows tooltip "Microphone not available. Check permissions."
- **Location:** `components/MicButton.tsx` lines 192-194
- **User Impact:** Voice input completely non-functional

### Code Analysis

**Entry Point:** `components/MicButton.tsx` - `toggleListening()` function
**Key Logic Flow:**
1. `useEffect` initializes microphone support check (lines 38-98)
2. `toggleListening()` called on button click (lines 100-170)
3. Error condition: `!isInitialized || !isSupported` triggers tooltip

**Critical Check Points:**
```typescript
// Line 42-53: HTTPS requirement
if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
  console.log('Microphone requires HTTPS context');
  setIsSupported(false);
  return;
}

// Line 56-61: Speech Recognition support
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  console.log('Speech recognition not supported in this browser');
  setIsSupported(false);
  return;
}

// Line 66-91: Permission check
if (navigator.permissions) {
  const permission = await navigator.permissions.query({ name: 'microphone' as PermissionName });
  setPermissionState(permission.state);
}
```

### Root Cause Hypotheses (Ranked by Likelihood)

#### 1. **HTTPS Context Issue** (Most Likely)
- **Evidence:** Code explicitly checks `location.protocol !== 'https:'` and `location.hostname !== 'localhost'`
- **Impact:** If app runs on non-HTTPS domain (not localhost), mic is disabled
- **Test:** Check if app is running on `http://` instead of `https://` or `localhost`

#### 2. **Browser Speech Recognition Support** (High Likelihood)
- **Evidence:** Requires both `SpeechRecognition` and `webkitSpeechRecognition` APIs
- **Impact:** Safari and some mobile browsers have limited/absent support
- **Test:** Check browser console for "Speech recognition not supported" message

#### 3. **Permission State Management** (Medium Likelihood)
- **Evidence:** Complex permission checking with multiple states (`granted`, `denied`, `prompt`, `unknown`)
- **Impact:** Race condition between permission check and button click
- **Test:** Check if `permissionState` is stuck in `unknown` or `denied`

#### 4. **getUserMedia API Availability** (Medium Likelihood)
- **Evidence:** Depends on `navigator.mediaDevices.getUserMedia`
- **Impact:** Older browsers or non-secure contexts lack this API
- **Test:** Check if `navigator.mediaDevices` exists

#### 5. **Initialization Race Condition** (Low Likelihood)
- **Evidence:** `isInitialized` state managed separately from `isSupported`
- **Impact:** Button clickable before initialization complete
- **Test:** Check timing between component mount and button click

### Diagnostic Infrastructure Added

**Files Created:**
- `lib/diagnostics/micProbe.ts` - Comprehensive environment probe
- `app/debug/mic/page.tsx` - Debug page for testing
- Enhanced `components/MicButton.tsx` with diagnostic logging

**Probe Capabilities:**
- Browser environment detection
- HTTPS context verification
- Permission API status
- Device enumeration
- getUserMedia test (with cleanup)
- Speech Recognition API availability

## Issue B: Splash→Login Flow Double Exposure

### Problem Description
- **Symptom:** "Heijō" brand appears twice/stacked during splash→login transition
- **Location:** Multiple components render brand elements simultaneously
- **User Impact:** Visual glitch, sometimes gets stuck in transition

### Code Analysis

**Flow Mapping:**
1. **HomePage** (`app/page.tsx`) - Entry point, decides splash vs login
2. **IntroAnimation** (`components/IntroAnimation.tsx`) - Space video + spinning H
3. **LoginPage** (`app/login/page.tsx`) - Final destination with brand elements

**Brand Element Locations:**
```typescript
// IntroAnimation.tsx lines 355-358
<div className="w-20 h-20 rounded-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
  <span className="text-4xl font-bold text-gray-800">H</span>
</div>

// LoginPage.tsx lines 73-76  
<div className="w-20 h-20 rounded-full silver-button flex items-center justify-center breathing-pulse">
  <span className="text-4xl font-bold text-graphite-charcoal brand-hero">H</span>
</div>
```

**Transition Logic:**
```typescript
// HomePage.tsx - Decision logic
if (hasSeenIntro()) {
  router.push('/login');  // Skip splash
} else {
  setShowIntro(true);     // Show splash
}

// IntroAnimation.tsx - Completion
const handleLogin = async (e: React.FormEvent) => {
  setTimeout(() => {
    onComplete();  // Calls router.push('/login')
  }, 1000);
};
```

### Root Cause Hypotheses (Ranked by Likelihood)

#### 1. **React StrictMode Double Mounting** (Most Likely)
- **Evidence:** Development mode causes double effect execution
- **Impact:** Two splash animations or redirects triggered simultaneously
- **Test:** Check if issue only occurs in development mode

#### 2. **Overlapping Component Rendering** (High Likelihood)
- **Evidence:** Both IntroAnimation and LoginPage render brand elements
- **Impact:** Visual overlap during transition period
- **Test:** Check if both components mount simultaneously

#### 3. **Missing Cleanup in useEffect** (Medium Likelihood)
- **Evidence:** IntroAnimation has complex GSAP animations and timers
- **Impact:** Previous component doesn't unmount before new one mounts
- **Test:** Check if IntroAnimation cleanup runs before LoginPage mounts

#### 4. **Router Race Condition** (Medium Likelihood)
- **Evidence:** Multiple `router.push('/login')` calls possible
- **Impact:** Navigation conflicts causing stuck state
- **Test:** Check for multiple navigation calls in console

#### 5. **CSS Z-Index Issues** (Low Likelihood)
- **Evidence:** Both components use `position: absolute` or similar
- **Impact:** Visual stacking instead of proper replacement
- **Test:** Check computed styles for overlapping elements

### Diagnostic Infrastructure Added

**Files Enhanced:**
- `app/page.tsx` - Added route transition tracing
- `components/IntroAnimation.tsx` - Added mount/unmount logging
- `app/login/page.tsx` - Added mount/unmount logging
- `lib/diagnostics/routeTrace.ts` - Centralized logging utility

**Trace Points:**
- Component mount/unmount events
- Router navigation calls
- Animation start/complete callbacks
- State transitions

## Remediation Plan

### Microphone Issue - Proposed Fixes

1. **HTTPS Context Fix** (Priority 1)
   - Add fallback for development environments
   - Consider using `window.location.origin` instead of `location.protocol`
   - Add user-friendly error message for non-HTTPS contexts

2. **Browser Compatibility Enhancement** (Priority 2)
   - Add feature detection for Speech Recognition APIs
   - Implement fallback to getUserMedia + server STT
   - Add browser-specific error messages

3. **Permission State Management** (Priority 3)
   - Simplify permission checking logic
   - Add retry mechanism for permission requests
   - Improve error handling for permission denied states

4. **Initialization Robustness** (Priority 4)
   - Add proper loading states
   - Implement initialization retry logic
   - Add user feedback during initialization

### Splash→Login Issue - Proposed Fixes

1. **StrictMode Compatibility** (Priority 1)
   - Make all effects idempotent
   - Add guards against double execution
   - Use refs to track execution state

2. **Component Lifecycle Management** (Priority 2)
   - Ensure proper cleanup in IntroAnimation
   - Add explicit unmounting before navigation
   - Implement proper transition states

3. **Router Navigation Control** (Priority 3)
   - Centralize navigation logic
   - Add navigation guards
   - Implement proper loading states

4. **Visual Transition Improvements** (Priority 4)
   - Add proper CSS transitions
   - Implement fade-out before navigation
   - Ensure single source of truth for brand elements

## Testing Matrix

### Microphone Testing
- **Browsers:** Chrome, Safari, Firefox, Edge
- **Contexts:** localhost, HTTPS, HTTP
- **Permissions:** First visit, Blocked, Allowed
- **Devices:** Desktop, Mobile

### Splash→Login Testing  
- **Modes:** Development, Production
- **States:** First visit, Returning user
- **Transitions:** Normal flow, Skip button, Direct navigation

## Environment Setup

To run diagnostics:
```bash
NEXT_PUBLIC_DEBUG=1 npm run dev
# Visit http://localhost:3000/debug/mic for microphone diagnostics
# Check browser console for route transition traces
```

## Next Steps

1. **Immediate:** Implement HTTPS context fix for microphone
2. **Short-term:** Add StrictMode compatibility for splash flow
3. **Medium-term:** Enhance browser compatibility and error handling
4. **Long-term:** Implement comprehensive testing suite

## ✅ Verified Fixes

### Microphone Issue - RESOLVED
- **Secure Context Fallback:** Added localhost fallback for development environments
- **Defensive Permissions:** Enhanced permission handling with graceful Safari/Edge fallbacks  
- **Unified Error Messages:** Implemented contextual error messages for different failure types
- **Status:** Microphone now activates on both HTTPS and localhost contexts

### Splash→Login Flow - RESOLVED  
- **StrictMode Safety:** Added idempotent guards to prevent double-mounting
- **Overlay Cleanup:** Implemented proper cleanup with data attributes for overlay removal
- **Race Protection:** Added auth redirect race protection to prevent conflicts
- **Status:** Single brand mark render, no stuck states, clean transitions

### Testing Results
- **Debug Page:** `/debug/mic` loads successfully with environment probe
- **Console Logs:** All diagnostic traces working correctly
- **No Linting Errors:** All code passes TypeScript and ESLint checks
- **Environment:** Debug mode properly guarded behind `NEXT_PUBLIC_DEBUG=1`

---

**Note:** This report includes both diagnostics and remediation phases. All diagnostic code remains guarded behind `NEXT_PUBLIC_DEBUG=1` flag and can be safely removed after verification.
